# Husky v10+: no shebang, no sourcing, POSIX-sh safe
set -e

# --- REUSE at repository root (strict check first) ---
if ! command -v reuse >/dev/null 2>&1; then
  echo "âŒ REUSE tool is required but not installed."
  echo "   Install it with: pip install reuse  OR  pipx install reuse"
  exit 1
fi

echo "ğŸ“œ REUSE license compliance (repo root)..."
if ! reuse lint; then
  echo "âŒ REUSE license compliance failed."
  exit 1
fi

# --- Rust checks inside firmware directory ---
(
  cd firmware || {
    echo "âš ï¸  'firmware' directory not found."
    exit 1
  }

  echo "ğŸ” Checking code formatting (cargo fmt)..."
  if ! cargo fmt --all -- --check; then
    echo "âŒ Code formatting issues detected. Run: cargo fmt --all"
    exit 1
  fi

  echo "ğŸ§  Running Clippy (RP2040 target)..."
  if ! cargo clippy --target thumbv6m-none-eabi -- -D warnings; then
    echo "âŒ Clippy failed with warnings/errors."
    exit 1
  fi

  echo "ğŸ—ï¸ Building (release, RP2040 target)..."
  if ! cargo build --release --target thumbv6m-none-eabi; then
    echo "âŒ Build failed."
    exit 1
  fi

  echo "âœ… cargo check (RP2040 target)..."
  if ! cargo check --target thumbv6m-none-eabi; then
    echo "âŒ cargo check failed."
    exit 1
  fi
)

echo "âœ… All checks passed! Proceeding with commit..."
